<!DOCTYPE html>
<meta charset="utf-8">
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'/>
<title>Social Media Analytic and Visualization: Visualizing traffic related tweets in Edmonton</title>

<head>
    {% load static %}
    <link rel="icon" href="{% static 'favicon.ico' %}">

    <!-- D3 library files -->
    <script src="{% static 'graph/d3.v4.min.js' %}"></script>
    <script src="{% static 'graph/dimple.v2.3.0.min.js' %}"></script>

    <!-- jQuery files link -->
    <script src="{% static '/jquery/jquery.min.js' %}"></script>

    <!-- jQuery's slider links -->
    <script src="{% static '/jquery/jquery-1.12.4.js' %}"></script>
    <script src="{% static '/jquery/jquery-ui.js' %}"></script>
    <link rel="stylesheet" href="{% static '/jquery/jquery-ui.css' %}">
    <link rel="stylesheet" href="{% static '/jquery/jquery-ui.structure.css' %}">
    <link rel="stylesheet" href="{% static '/jquery/jquery-ui.theme.css' %}">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="{% static '/bootstrap/bootstrap.min.css' %}">

    <!-- Optional theme -->
    <link rel="stylesheet" href="{% static '/bootstrap/bootstrap-theme.min.css' %}">

    <!-- Latest compiled and minified JavaScript -->
    <script src="{% static '/bootstrap/bootstrap.min.js' %}"></script>

    <link rel="stylesheet" type="text/css" href="{% static '/traffic_data/keen-dashboards.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'tweets.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'graph/bar-graphs.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'main.css' %}">

    <script>
        var min_date = "{{ min_date }}".substring(0, 13);
        var max_date = "{{ max_date }}".substring(0, 13);
    </script>

    <script src="{% static 'graph/barGraph.js' %}"></script>
    <script src="{% static 'graph/lineGraph.js' %}"></script>
    <script src="{% static 'tweet_info.js' %}"></script>
    <script src="{% static 'listeners.js' %}"></script>
    <script src="{% static 'datepicker.js' %}"></script>
    <script src="{% static 'reload_page.js' %}"></script>

</head>

<body class="keen-dashboard" style="padding-top: 80px;">
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div id="header-bar" class="container-fluid">
        <div class="row" id="flex">
            <div class="col-sm-4">
                <a class="head-title" href="./">
                    <p>Social Media Analytic and Visualization</p>
                    <p1>Visualizing traffic related tweets in Edmonton</p1>
                </a>
            </div>
            <div class="col-sm-2">
                <p1 class="num-tweet" class="header-text">Number of Tweets:</p1>

                <button id="tweet_btn" class="btn btn-secondary btn-sm dropdown-toggle" type="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">10 <i class="caret"></i>
                </button>
                <ul id="num_tweets" class="dropdown-menu">
                    <li><a class="item">5</a></li>
                    <li><a class="item">10</a></li>
                    <li><a class="item">15</a></li>
                    <li><a class="item">20</a></li>
                    <li><a class="item">25</a></li>
                    <li><a class="item">30</a></li>
                </ul>
            </div>
            <div class="col-sm-2">
                <p1 class="hashtag">Hashtag:</p1>
                <button id="hashtag-dropdown" class="btn btn-secondary btn-sm dropdown-toggle" type="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">All <i id="dropdown_caret"
                                                                                                 class="caret"></i>
                </button>
                <ul id="hashtag-list" class="dropdown-menu">
                    <li><a class="item">All</a></li>
                    <li><a class="item">#yegtraffic</a></li>
                    <li><a class="item">#visionzero</a></li>
                    <li><a class="item">#abroads</a></li>
                </ul>
            </div>
            <!--Date picker text fields with calender-->
            <div class="col-sm-5">
                <label class="datepicker" for="from">From</label>
                <input type="text" id="from" name="from" placeholder="choose starting date">
                <label class="datepicker" for="to">to</label>
                <input type="text" id="to" name="to" placeholder="choose ending date">
            </div>
            <div class="col-sm-1" id="updated">
                <a id="bind" class="header-text" href=""><b>Update Tweets</b></a>
            </div>
        </div>
    </div>
</div>
</body>

<div id="graphs-id" class="container-fluid">
    <div class="row">
        <div class="col-sm-8 graphs">
            <div class="bar-graphs" id="bar_graphs">
                <div class="sentiment" id="sentiment">
                    <script async>
                        var pos = {{ sentimentCounts.0 | safe }};
                        var neu = {{ sentimentCounts.1 | safe }};
                        var neg = {{ sentimentCounts.2 | safe }};

                        if (pos > 0 || neg > 0 || neu > 0) {
                            sentimentData = [
                                {"Sentiment": "Positive", "Number of Tweets": pos},
                                {"Sentiment": "Neutral", "Number of Tweets": neu},
                                {"Sentiment": "Negative", "Number of Tweets": neg}
                            ];
                        }
                        else {
                            sentimentData = [];
                        }

                        makeSentimentGraph(sentimentData, ".sentiment", "Tweets by Sentiment", "Number of Tweets", "Sentiment");

                        function get_recent_tweets() {
                            var block = [];
                            var date;
                            var formattedDate;
                            var t_body;
                            var screen_name;
                            var name;
                            var t_url;
                            var t_rating;

                            {% for tweet in recentTweets %}
                                date = new Date("{{ tweet.creation_date | safe }}");
                                formattedDate = date.toDateString();
                                t_body = "{{ tweet.tweet_body | safe }}";
                                screen_name = "{{ tweet.user_id.screen_name | safe }}";
                                name = "{{ tweet.user_id.name | safe }}";
                                t_url = "{{ tweet.tweet_url }}";
                                t_rating = "{{ tweet.sentiment_string | safe }}";
                                block.push(process_tweet(t_body, formattedDate, screen_name, name, t_url, t_rating));
                            {% endfor %}

                            return block;
                        }

                        var max_tweets = $("#tweet_btn").text();
                        var recent_tweets = get_recent_tweets();
                        var recent_title = make_tweets_title('recent', max_tweets);

                        $("#tweets").html("<b>" + recent_title + "</b>");
                        $("#tweets").append(recent_tweets.slice(0, max_tweets));
                        bind_tweets('.sentiment', 'recent', recent_tweets.slice(0, max_tweets), max_tweets);

                        $(document).ready(function () {
                            $('#num_tweets a').click(function () {
                                var max_tweets = $(this).text();
                                update_tweets('recent', recent_tweets.slice(0, max_tweets));
                                bind_tweets('.sentiment', 'recent', recent_tweets.slice(0, max_tweets), max_tweets);
                            });
                        });
                    </script>

                </div>

                <div class="retweet" id="retweet">
                    <script async>

                        function get_rt_data() {
                            var retweetData = [];
                            var userName;
                            var rtc;
                            var tid;
                            var id;
                            var tid_split;
                            {% for item in retweetCounts %}
                                userName = "{{ item.user_id.screen_name | safe }}";
                                rtc = "{{ item.rt_count | safe }}";
                                tid = "{{ item.tweet_url | safe }}";
                                tid_split = tid.split("/");
                                if (tid_split.length == 5) {
                                    id = tid_split[4];
                                }
                                else {
                                    id = tid_split[5];
                                }

                                if (rtc > 0) {
                                    retweetData.push(
                                        {"User": userName, "Number of Retweets": rtc, "ID": id}
                                    );
                                }
                            {% endfor %}
                            return retweetData;
                        }

                        function get_rt_tweets() {
                            var rt_block = [];
                            var date;
                            var formattedDate;
                            var t_body;
                            var screen_name;
                            var name;
                            var t_url;
                            var t_rating;
                            var t_id;
                            var rtc;
                            {% for tweet in topRetweet %}
                                date = new Date("{{ tweet.creation_date | safe }}");
                                formattedDate = date.toDateString();
                                t_body = "{{ tweet.tweet_body | safe }}";
                                screen_name = "{{ tweet.user_id.screen_name | safe }}";
                                name = "{{ tweet.user_id.name | safe }}";
                                t_url = "{{ tweet.tweet_url }}";
                                t_rating = "{{ tweet.sentiment_string | safe }}";
                                t_id = "{{ tweet.tweet_id | safe }}";
                                rtc = "{{ tweet.rt_count | safe }}";
                                if (rtc > 0) {
                                    rt_block.push(process_tweet(t_body, formattedDate, screen_name, name, t_url, t_rating, t_id));
                                }
                            {% endfor %}
                            return rt_block;
                        }

                        var rt_data = get_rt_data();
                        var max_tweets = $("#tweet_btn").text();
                        max_tweets = max_tweets.replace(/\s+/g, "");
                        var rt_container = ".retweet";
                        var rt_title = "Most Retweeted";
                        var rt_x_title = "Number of Retweets";
                        var rt_tweets = get_rt_tweets();

                        makeSocialGraph(rt_data.slice(0, max_tweets), rt_container, rt_title, rt_x_title);
                        bind_tweets(rt_container, 'retweet', rt_tweets.slice(0, max_tweets), max_tweets);

                        $(document).ready(function () {
                            $('#num_tweets a').click(function () {
                                var max_tweets = $(this).text();
                                var new_data = rt_data.slice(0, max_tweets);
                                redraw_socialgraph(new_data, rt_container, rt_title, rt_x_title);
                                update_tweets('retweet', rt_tweets.slice(0, max_tweets));
                                bind_tweets(rt_container, 'retweet', rt_tweets.slice(0, max_tweets), max_tweets);
                            });
                        });
                    </script>
                </div>

                <div class="favourite" id="favourite">
                    <script async>
                        function get_fav_data() {
                            var favouriteData = [];
                            var userName;
                            var favc;
                            var tid;
                            var tid_split;
                            var id;
                            {% for item in favouriteCounts %}
                                userName = "{{ item.user_id.screen_name | safe }}";
                                favc = "{{ item.fav_count | safe }}";
                                tid = "{{ item.tweet_url | safe }}";
                                tid_split = tid.split("/");
                                if (tid_split.length == 5) {
                                    id = tid_split[4];
                                }
                                else {
                                    id = tid_split[5];
                                }
                                if (favc > 0) {
                                    favouriteData.push(
                                        {"User": userName, "Number of Favourites": favc, "ID": id}
                                    );
                                }
                            {% endfor %}

                            return favouriteData;
                        };

                        function get_fav_tweets() {
                            var fav_block = [];
                            var date;
                            var formattedDate;
                            var t_body;
                            var screen_name;
                            var name;
                            var t_url;
                            var t_rating;
                            var t_id;
                            var favc;
                            {% for tweet in topFavorite %}
                                date = new Date("{{ tweet.creation_date | safe }}");
                                formattedDate = date.toDateString();
                                t_body = "{{ tweet.tweet_body | safe }}";
                                screen_name = "{{ tweet.user_id.screen_name | safe }}";
                                name = "{{ tweet.user_id.name | safe }}";
                                t_url = "{{ tweet.tweet_url }}";
                                t_rating = "{{ tweet.sentiment_string | safe }}";
                                t_id = "{{ tweet.tweet_id | safe }}";
                                favc = "{{ tweet.fav_count | safe }}";
                                if (favc > 0) {
                                    fav_block.push(process_tweet(t_body, formattedDate, screen_name, name, t_url, t_rating, t_id));
                                }
                            {% endfor %}
                            return fav_block;
                        }

                        var max_tweets = $("#tweet_btn").text();
                        max_tweets = max_tweets.replace(/\s+/g, "");
                        var fav_data = get_fav_data();
                        var fav_container = ".favourite";
                        var fav_title = "Most Favourited";
                        var fav_x_title = "Number of Favourites";
                        var fav_tweets = get_fav_tweets();

                        makeSocialGraph(fav_data.slice(0, max_tweets), fav_container, fav_title, fav_x_title);
                        bind_tweets(fav_container, 'favourite', fav_tweets.slice(0, max_tweets), max_tweets);

                        $(document).ready(function () {
                            $('#num_tweets a').click(function () {
                                var max_tweets = $(this).text();
                                var new_data = fav_data.slice(0, max_tweets);
                                redraw_socialgraph(new_data, fav_container, fav_title, fav_x_title);
                                update_tweets('favourite', fav_tweets.slice(0, max_tweets));
                                bind_tweets(fav_container, 'favourite', fav_tweets.slice(0, max_tweets), max_tweets);
                            });
                        });

                    </script>

                </div>
            </div>
{#            <div class="sent_line" id="sent_line">#}
{#                <script async>#}
{#                    var data = [];#}
{#                    var sent;#}
{#                    var date;#}
{#                    var formattedDate;#}
{#                    var t_body;#}
{#                    var user;#}
{##}
{#                    {% for tweet in tweets %}#}
{#                        sent = {{ tweet.sentiment | safe }};#}
{#                        date = new Date("{{ tweet.creation_date | safe }}");#}
{#                        formattedDate = date.toString().substring(0, 24);#}
{#                        t_body = "{{ tweet.tweet_body | safe }}";#}
{#                        user = "{{ tweet.user_id.screen_name | safe }}";#}
{##}
{#                        data.push(#}
{#                            {"Created": formattedDate, "Sentiment": sent, "Tweet": t_body, "User": user}#}
{#                        );#}
{#                    {% endfor %}#}
{##}
{#                    makeLineGraph(data, ".sent_line", "Sentiment Over Time");#}
{#                </script>#}
{##}
{#            </div>#}
        </div>
        <div id="tweets" class="col-sm-4" tweets-type="recent">
            <div id="top_tweets">
                <script async>

                    var block = [];
                    var date;
                    var formattedDate;
                    var t_body;
                    var screen_name;
                    var name;
                    var t_url;
                    var t_rating;
                    var t_id;

                    function get_recent_tweets() {
                        block = [];
                        {% for tweet in recentTweets %}
                            date = new Date("{{ tweet.creation_date | safe }}");
                            formattedDate = date.toDateString();
                            t_body = "{{ tweet.tweet_body | safe }}";
                            screen_name = "{{ tweet.user_id.screen_name | safe }}";
                            name = "{{ tweet.user_id.name | safe }}";
                            t_url = "{{ tweet.tweet_url }}";
                            t_rating = "{{ tweet.sentiment_string | safe }}";
                            t_id = "{{ tweet.tweet_id | safe }}";
                            block.push(process_tweet(t_body, formattedDate, screen_name, name, t_url, t_rating, t_id));
                        {% endfor %}

                        return block;
                    }

                    var max_tweets = $("#tweet_btn").text();
                    max_tweets = max_tweets.replace(/\s+/g, "");
                    var recent_tweets = get_recent_tweets();
                    var recent_title = make_tweets_title('recent', max_tweets);


                    $("#tweets").html("<b>" + recent_title + "</b>");
                    $("#tweets").append(recent_tweets.slice(0, max_tweets));
                    bind_tweets('.sentiment', 'recent', recent_tweets.slice(0, max_tweets), max_tweets);

                    $(document).ready(function () {
                        $('#num_tweets a').click(function () {
                            var max_tweets = $(this).text();
                            update_tweets('recent', recent_tweets.slice(0, max_tweets));
                            bind_tweets('.sentiment', 'recent', recent_tweets.slice(0, max_tweets), max_tweets);
                        });
                    });
                </script>


            </div>
        </div>
    </div>
</div>

{% csrf_token %}

</div>

</html>
